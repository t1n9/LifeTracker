name: Build and Deploy LifeTracker

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Build Backend
      run: |
        cd backend
        npm ci
        npm run build

    - name: Build Frontend
      run: |
        cd frontend
        npm ci
        npm run build

    - name: Create deployment package
      run: |
        mkdir -p deploy-package

        # å¤åˆ¶åç«¯æ–‡ä»¶
        cp -r backend/dist deploy-package/backend-dist
        cp backend/package.json deploy-package/backend-package.json
        cp backend/package-lock.json deploy-package/backend-package-lock.json

        # å¤åˆ¶å‰ç«¯æ–‡ä»¶
        cp -r frontend/.next deploy-package/frontend-dist
        cp frontend/package.json deploy-package/frontend-package.json

        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp docker-compose.prod.yml deploy-package/ || cp docker-compose.yml deploy-package/docker-compose.prod.yml
        cp -r nginx deploy-package/
        cp deploy-prod.sh deploy-package/ || echo "#!/bin/bash" > deploy-package/deploy-prod.sh

        # åˆ›å»ºå‹ç¼©åŒ…
        tar -czf deploy-package.tar.gz deploy-package/

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Upload deployment package
      run: |
        scp -o StrictHostKeyChecking=no deploy-package.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/

    - name: Deploy to server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e

          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /opt/lifetracker || {
            echo "åˆ›å»ºé¡¹ç›®ç›®å½•..."
            mkdir -p /opt/lifetracker
            cd /opt/lifetracker
          }

          # å¤‡ä»½ç°æœ‰éƒ¨ç½²
          if [ -d "current" ]; then
            echo "å¤‡ä»½ç°æœ‰éƒ¨ç½²..."
            rm -rf backup || true
            mv current backup || true
          fi

          # è§£å‹æ–°çš„éƒ¨ç½²åŒ…
          echo "è§£å‹éƒ¨ç½²åŒ…..."
          mkdir -p current
          cd current
          tar -xzf /tmp/deploy-package.tar.gz --strip-components=1
          rm -f /tmp/deploy-package.tar.gz
          
          # åˆ›å»ºSSLè¯ä¹¦ç›®å½•
          mkdir -p nginx/ssl
          
          # ç”Ÿæˆç¯å¢ƒå˜é‡æ–‡ä»¶
          echo "ç”Ÿæˆç¯å¢ƒå˜é‡æ–‡ä»¶..."
          echo "DOMAIN_NAME=${{ secrets.DOMAIN_NAME }}" > .env
          echo "DB_NAME=lifetracker" >> .env
          echo "DB_USER=lifetracker" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "NODE_ENV=production" >> .env

          # æ‰§è¡Œç”Ÿäº§éƒ¨ç½²è„šæœ¬
          echo "ğŸš€ æ‰§è¡Œç”Ÿäº§éƒ¨ç½²..."
          chmod +x deploy-prod.sh
          ./deploy-prod.sh
        EOF

    - name: Verify deployment
      run: |
        # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
        sleep 180

        # æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸
        if curl -f https://${{ secrets.DOMAIN_NAME }}/api/health; then
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼æœåŠ¡æ­£å¸¸è¿è¡Œ"
        else
          echo "âŒ éƒ¨ç½²å¯èƒ½æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€"
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "cd /opt/lifetracker/current && docker-compose -f docker-compose.prod.yml ps && docker-compose -f docker-compose.prod.yml logs --tail=50"
          exit 1
        fi
