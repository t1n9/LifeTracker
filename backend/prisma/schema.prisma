generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String            @id @default(uuid())
  email            String            @unique
  passwordHash     String            @map("password_hash")
  name             String?
  targetName       String?           @map("target_name")
  targetDate       DateTime?         @map("target_date") @db.Timestamptz(6)
  examDate         DateTime?         @map("exam_date") @db.Timestamptz(6)
  timezone         String            @default("Asia/Shanghai")
  theme            String            @default("dark")
  isActive         Boolean           @default(true) @map("is_active")
  emailVerified    Boolean           @default(false) @map("email_verified")
  createdAt        DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  showPullUps      Boolean?          @default(true) @map("show_pull_ups")
  showSquats       Boolean?          @default(true) @map("show_squats")
  showPushUps      Boolean?          @default(true) @map("show_push_ups")
  showRunning      Boolean?          @default(true) @map("show_running")
  showSwimming     Boolean?          @default(false) @map("show_swimming")
  showCycling      Boolean?          @default(false) @map("show_cycling")
  isAdmin          Boolean           @default(false) @map("is_admin")
  countdowns       Countdown[]
  dailyData        DailyData[]
  exerciseRecords  ExerciseRecord[]  @relation("UserExerciseRecords")
  exerciseTypes    ExerciseType[]    @relation("UserExerciseTypes")
  expenseRecords   ExpenseRecord[]   @relation("UserExpenseRecords")
  healthRecords    HealthRecord[]
  importantInfos   ImportantInfo[]
  pomodoroSessions PomodoroSession[]
  shareLinks       ShareLink[]       @relation("UserShareLinks")
  studyRecords     StudyRecord[]
  tasks            Task[]
  userSettings     UserSettings?

  // 访客统计关联
  profileVisitors  ProfileVisitor[]  @relation("ProfileVisitors") // 访问我的用户
  visitorRecords   ProfileVisitor[]  @relation("VisitorRecords")  // 我访问的记录
  profileVisitLogs ProfileVisitLog[] @relation("ProfileVisitLogs") // 我的访问日志

  @@map("users")
}

model UserSettings {
  id                     String  @id @default(uuid())
  userId                 String  @unique @map("user_id")
  pomodoroWorkDuration   Int     @default(25) @map("pomodoro_work_duration")
  pomodoroBreakDuration  Int     @default(5) @map("pomodoro_break_duration")
  pomodoroLongBreak      Int     @default(15) @map("pomodoro_long_break")
  pomodoroSoundEnabled   Boolean @default(true) @map("pomodoro_sound_enabled")
  notificationsEnabled   Boolean @default(true) @map("notifications_enabled")
  dailyGoalHours         Float   @default(8.0) @map("daily_goal_hours")
  weeklyGoalHours        Float   @default(40.0) @map("weekly_goal_hours")
  studySubjects          Json    @default("{}") @map("study_subjects")
  exerciseTypes          Json    @default("{}") @map("exercise_types")
  expenseCategories      Json    @default("{}") @map("expense_categories")
  themeConfig            Json    @default("{}") @map("theme_config")
  currentImportantInfoId String? @map("current_important_info_id")
  user                   User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model Task {
  id               String            @id @default(uuid())
  userId           String            @map("user_id")
  title            String
  description      String?
  subject          String?
  priority         Int               @default(0)
  isCompleted      Boolean           @default(false) @map("is_completed")
  dueDate          DateTime?         @map("due_date") @db.Timestamptz(6)
  estimatedHours   Float?            @map("estimated_hours")
  actualHours      Float?            @map("actual_hours")
  sortOrder        Int               @default(0) @map("sort_order")
  createdAt        DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  pomodoroSessions PomodoroSession[]
  studyRecords     StudyRecord[]
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("tasks")
}

model StudyRecord {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  taskId      String?   @map("task_id")
  duration    Int
  subject     String?
  notes       String?
  startedAt   DateTime  @map("started_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  task        Task?     @relation(fields: [taskId], references: [id])
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("study_records")
}

model PomodoroSession {
  id             String         @id @default(uuid())
  userId         String         @map("user_id")
  taskId         String?        @map("task_id")
  duration       Int
  actualDuration Int?           @map("actual_duration")
  status         PomodoroStatus
  type           PomodoroType   @default(WORK)
  startedAt      DateTime       @map("started_at") @db.Timestamptz(6)
  completedAt    DateTime?      @map("completed_at") @db.Timestamptz(6)
  pausedAt       DateTime?      @map("paused_at") @db.Timestamptz(6)
  resumedAt      DateTime?      @map("resumed_at") @db.Timestamptz(6)
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  countUpTime    Int?           @default(0) @map("count_up_time")
  isCountUpMode  Boolean        @default(false) @map("is_count_up_mode")
  task           Task?          @relation(fields: [taskId], references: [id])
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("pomodoro_sessions")
}

model Countdown {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  title       String
  description String?
  targetDate  DateTime @map("target_date") @db.Timestamptz(6)
  isActive    Boolean  @default(true) @map("is_active")
  color       String   @default("#3182CE")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("countdowns")
}

model DailyData {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  date            DateTime @db.Date
  totalMinutes    Int      @default(0) @map("total_minutes")
  pomodoroCount   Int      @default(0) @map("pomodoro_count")
  dayStart        String?  @map("day_start")
  dayReflection   String?  @map("day_reflection")
  reflectionTime  String?  @map("reflection_time")
  focusMode       Boolean  @default(false) @map("focus_mode")
  focusQuoteIndex Int      @default(0) @map("focus_quote_index")
  exerciseFeeling String?  @map("exercise_feeling")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("daily_data")
}

model ImportantInfo {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("important_info")
}

model ExerciseRecord {
  id         String       @id @default(uuid())
  userId     String       @map("user_id")
  exerciseId String       @map("exercise_id")
  date       DateTime     @db.Date
  value      Float
  unit       String
  notes      String?
  createdAt  DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  exercise   ExerciseType @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  user       User         @relation("UserExerciseRecords", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, exerciseId, date])
  @@index([userId, date])
  @@index([userId, exerciseId])
  @@map("exercise_records")
}

model ExerciseType {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  name      String
  type      ExerciseTypeEnum
  unit      String
  increment Float?
  icon      String?
  color     String?
  isActive  Boolean          @default(true) @map("is_active")
  sortOrder Int              @default(0) @map("sort_order")
  createdAt DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  records   ExerciseRecord[]
  user      User             @relation("UserExerciseTypes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@map("exercise_types")
}

model MigrationLog {
  id            String   @id @default(uuid())
  migrationName String   @map("migration_name")
  status        String
  details       String?
  createdAt     DateTime @map("created_at") @db.Timestamptz(6)

  @@map("migration_logs")
}

model EmailVerification {
  id        String   @id @default(uuid())
  email     String
  code      String
  purpose   String
  used      Boolean  @default(false)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([email, code, purpose])
  @@index([expiresAt])
  @@map("email_verifications")
}

model ExpenseRecord {
  id          String          @id @default(uuid())
  userId      String          @map("user_id")
  date        DateTime        @db.Date
  type        ExpenseTypeEnum
  category    String
  amount      Float
  description String?
  time        String?
  notes       String?
  createdAt   DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)
  user        User            @relation("UserExpenseRecords", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([userId, type])
  @@index([userId, date, type])
  @@map("expense_records")
}

model ShareLink {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  shareCode   String   @unique @map("share_code")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user        User     @relation("UserShareLinks", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("share_links")
}

model HealthRecord {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  date         DateTime @db.Date
  weight       Float?
  sleepHours   Float?   @map("sleep_hours")
  sleepQuality Int?     @map("sleep_quality")
  phoneUsage   Float?   @map("phone_usage")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@map("health_records")
}

model SystemConfig {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String
  description String?
  isPublic    Boolean  @default(false) @map("is_public")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("system_configs")
}

enum ExerciseTypeEnum {
  COUNT
  DISTANCE
}

enum ExpenseTypeEnum {
  MEAL
  OTHER
}

enum PomodoroStatus {
  PENDING
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
}

enum PomodoroType {
  WORK
  SHORT_BREAK
  LONG_BREAK
}

enum DeviceType {
  DESKTOP
  MOBILE
  TABLET
}

// 访客统计表
model ProfileVisitor {
  id                String      @id @default(uuid())
  profileUserId     String      @map("profile_user_id") // 被访问的用户ID
  visitorUserId     String?     @map("visitor_user_id") // 访客用户ID（如果已登录）
  deviceFingerprint String      @map("device_fingerprint") // 设备指纹
  ipAddress         String      @map("ip_address")
  userAgent         String      @map("user_agent")
  sessionId         String      @map("session_id")

  // 地理位置信息
  country           String?
  city              String?

  // 设备信息
  deviceType        DeviceType  @map("device_type")
  browser           String?
  os                String?

  // 访问统计
  firstVisitAt      DateTime    @map("first_visit_at") @db.Timestamptz(6)
  lastVisitAt       DateTime    @map("last_visit_at") @db.Timestamptz(6)
  visitCount        Int         @default(1) @map("visit_count")

  // 来源信息
  referrer          String?
  utmSource         String?     @map("utm_source")
  utmMedium         String?     @map("utm_medium")
  utmCampaign       String?     @map("utm_campaign")

  createdAt         DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)

  // 关联关系
  profileUser       User               @relation("ProfileVisitors", fields: [profileUserId], references: [id], onDelete: Cascade)
  visitorUser       User?              @relation("VisitorRecords", fields: [visitorUserId], references: [id], onDelete: SetNull)
  visitLogs         ProfileVisitLog[]  // 访问日志

  // 索引
  @@unique([profileUserId, deviceFingerprint]) // 同一用户的同一设备只记录一次
  @@index([profileUserId, lastVisitAt])
  @@index([deviceFingerprint])
  @@index([ipAddress, userAgent])
  @@map("profile_visitors")
}

// 访问记录表（详细的每次访问）
model ProfileVisitLog {
  id                String      @id @default(uuid())
  profileUserId     String      @map("profile_user_id")
  visitorId         String      @map("visitor_id") // 关联到 ProfileVisitor

  // 访问详情
  visitedAt         DateTime    @map("visited_at") @db.Timestamptz(6)
  duration          Int?        @map("duration") // 停留时间（秒）
  pageViews         Int         @default(1) @map("page_views") // 页面浏览数

  // 访问来源
  referrer          String?
  utmSource         String?     @map("utm_source")
  utmMedium         String?     @map("utm_medium")
  utmCampaign       String?     @map("utm_campaign")

  createdAt         DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)

  // 关联关系
  profileUser       User           @relation("ProfileVisitLogs", fields: [profileUserId], references: [id], onDelete: Cascade)
  visitor           ProfileVisitor @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  // 索引
  @@index([profileUserId, visitedAt])
  @@index([visitorId])
  @@map("profile_visit_logs")
}
