<!DOCTYPE html>
<html>
<head>
    <title>LifeTracker API Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { margin: 5px; padding: 10px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <h1>LifeTracker API 调试工具</h1>
    
    <div class="section">
        <h3>1. 认证测试</h3>
        <button onclick="testLogin()">测试登录</button>
        <button onclick="testAuth()">测试认证状态</button>
        <div id="auth-result" class="result"></div>
    </div>

    <div class="section">
        <h3>2. 运动数据测试</h3>
        <button onclick="testExerciseToday()">获取今日运动</button>
        <button onclick="testExerciseTypes()">获取运动类型</button>
        <button onclick="testUpdateExercise()">测试更新运动</button>
        <div id="exercise-result" class="result"></div>
    </div>

    <div class="section">
        <h3>3. 消费数据测试</h3>
        <button onclick="testExpenseToday()">获取今日消费</button>
        <button onclick="testUpdateMeal()">测试更新餐饮</button>
        <div id="expense-result" class="result"></div>
    </div>

    <div class="section">
        <h3>4. 历史数据测试</h3>
        <button onclick="testHistoryDates()">获取历史日期</button>
        <button onclick="testTodayHistory()">获取今日历史</button>
        <div id="history-result" class="result"></div>
    </div>

    <script>
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:3002/api' 
            : 'https://t1n9.xyz/api';

        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${isError ? 'error' : 'success'}">${message}</div>`;
        }

        async function apiCall(url, options = {}) {
            const token = localStorage.getItem('token');
            const headers = {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` }),
                ...options.headers
            };

            try {
                const response = await fetch(`${API_BASE}${url}`, {
                    ...options,
                    headers
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(`${response.status}: ${data.message || 'Unknown error'}`);
                }
                
                return data;
            } catch (error) {
                throw error;
            }
        }

        async function testLogin() {
            try {
                // 这里需要实际的用户凭据
                const email = prompt('请输入邮箱:');
                const password = prompt('请输入密码:');
                
                if (!email || !password) {
                    log('auth-result', '请输入邮箱和密码', true);
                    return;
                }

                const result = await apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                localStorage.setItem('token', result.access_token);
                log('auth-result', `登录成功! Token: ${result.access_token.substring(0, 20)}...`);
            } catch (error) {
                log('auth-result', `登录失败: ${error.message}`, true);
            }
        }

        async function testAuth() {
            try {
                const result = await apiCall('/auth/me');
                log('auth-result', `认证成功! 用户: ${result.name} (${result.email})`);
            } catch (error) {
                log('auth-result', `认证失败: ${error.message}`, true);
            }
        }

        async function testExerciseToday() {
            try {
                const result = await apiCall('/exercise/today');
                log('exercise-result', `今日运动数据: ${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                log('exercise-result', `获取运动数据失败: ${error.message}`, true);
            }
        }

        async function testExerciseTypes() {
            try {
                const result = await apiCall('/exercise/types');
                log('exercise-result', `运动类型: ${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                log('exercise-result', `获取运动类型失败: ${error.message}`, true);
            }
        }

        async function testUpdateExercise() {
            try {
                // 先获取运动类型
                const types = await apiCall('/exercise/types');
                if (!types.data || types.data.length === 0) {
                    log('exercise-result', '没有运动类型，无法测试更新', true);
                    return;
                }

                const exerciseId = types.data[0].id;
                const result = await apiCall('/exercise/records/today', {
                    method: 'PUT',
                    body: JSON.stringify({
                        exerciseId: exerciseId,
                        totalValue: 10,
                        notes: '测试更新'
                    })
                });

                log('exercise-result', `更新运动成功: ${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                log('exercise-result', `更新运动失败: ${error.message}`, true);
            }
        }

        async function testExpenseToday() {
            try {
                const result = await apiCall('/expense/today');
                log('expense-result', `今日消费数据: ${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                log('expense-result', `获取消费数据失败: ${error.message}`, true);
            }
        }

        async function testUpdateMeal() {
            try {
                const result = await apiCall('/expense/meals', {
                    method: 'PUT',
                    body: JSON.stringify({
                        category: 'breakfast',
                        amount: 25
                    })
                });

                log('expense-result', `更新餐饮成功: ${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                log('expense-result', `更新餐饮失败: ${error.message}`, true);
            }
        }

        async function testHistoryDates() {
            try {
                const result = await apiCall('/history/dates');
                log('history-result', `历史日期: ${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                log('history-result', `获取历史日期失败: ${error.message}`, true);
            }
        }

        async function testTodayHistory() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const result = await apiCall(`/history/day/${today}`);
                log('history-result', `今日历史数据: ${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                log('history-result', `获取今日历史失败: ${error.message}`, true);
            }
        }

        // 页面加载时检查认证状态
        window.onload = function() {
            const token = localStorage.getItem('token');
            if (token) {
                log('auth-result', `已有Token: ${token.substring(0, 20)}...`);
                testAuth();
            } else {
                log('auth-result', '未登录，请先测试登录', true);
            }
        };
    </script>
</body>
</html>
